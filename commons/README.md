# Commons

工程的公用代码库

## 简介

将需要在项目中需要共享的代码组织于此，可以通过引用模块的方式方便的管理通用代码。

本模块代码的公共包名为`info.skyblond.vovoku.commons`。

## 功能

### Constance.kt

本文件存储了需要共享的常量，通常为Redis的Channel名称、Key前缀等需要维持统一的字面常量。

### CryptoUtil

本类提供了密码学相关的代码，其中包括基于RSA算法的私钥签名、公钥验证、公钥加密、私钥解密，MD5信息摘要，基于AES算法的加密和解密。

其中RSA签名算法为`SHA512withRSA`，AES算法为`AES/GCM/NoPadding`。由于RSA加密时数据长度不能超过501字节，超长数据需要分片处理，故原计划使用RSA签名验证超控接口请求、RSA加密保证非授权不可访问的计划修改为使用AES，即通过MD5计算请求摘要，通过AES加密该MD5，超控接口收到请求后对比解密的得到的MD5和请求体得到的MD5是否相同以实现鉴权。目前RSA算法在项目内没有实用。

### FilePathUtil

系统设计伊始即为分布式系统，故使用FilePath的机制来处理分布数据的问题。目前提供两种前缀：

+ `base64://`：此前缀表示后面的字符串就是基于Base64编码的数据，目的是解决单一训练样本太小，会造成文件系统产生过多碎片而影响性能，于是使用此编码直接将数据存储在数据库中。
+ `file://`：此前缀表示后面的路径为本地文件系统的路径，用于存储一般性的文件。

本类通过对不同的前缀进行不同的处理，根据读写需求返回通用的InputStream或OutputStream，使得该设计在原理上可以通过拓展前缀，实现对不同前缀的解析，进而实现无缝将数据托管在其他平台上，如阿里云OSS、亚马逊S3或星际文件系统IPFS等。

### JacksonJsonUtil

为了统一项目中引用的依赖，在Json处理方面选用Jackson而非Gson。由于Jackson使用前配置较多，因此设计的统一的工具类简化其他部分代码的Json操作。

该工具类提供字符串与对象之间的转换，也支持直接将对象转化为Json后写入文件，和直接读取文件中的Json并转换回对象。

### JacksonYamlUtil

由于Json对于人类可读性与易用性有待商榷，因此项目使用Yaml作为配置文件的格式。该工具类与上面的Json工具类相似，但因为主要用于配置文件，故只提供文件与对象之间的交互。

### UBytePicUtil

为了便于后台处理数据，所有的图片数据将直接转化为字节数据存储，该工具类可以将BufferedImage转换为字节数组和相关信息的元组，反过来同样可以转换。

转换后的字节数组索引`[x * height * channel + y * channel + i]`等同于原来图片的`[x, y, i]`，其中x为横坐标，y为纵坐标，i为通道数（ABGR、BGR、GRAY）。

### models

该包内全部为数据类，为需要共享的数据结构。如用于超控接口的请求体数据结构`AdminRequest`、对应数据库的POJO、用于在Redis上传递的数据结构等。

### dl4j

该包内为用于DL4J训练框架的类。

在设计上力求最大的灵活性，使得系统支持的网络类型并不局限于某一个网络，而是可以基于本包系统的接口任意扩展。

本系统将一个网络抽象为`ModelPrototype`，该类中包含了描述和训练一个模型的全部信息，诸如数据的解析、网络结构的描述、面向用户的参数说明等。同时该接口也提供静态成员，使得可以基于模型名方便的拿到对应的`ModelPrototype`实现。

每个Prototype包含两个工厂、一个描述子和三个抽象方法，分别如下：

`DataFetcherFactory`允许调用者通过Prototype获取能够解析数据的DataSetFetcher，将字节数组转换为DL4J能够识别的数据。

`DataSetIteratorFactory`允许调用者提供已有的DataFetcher得到用于训练模型的数据集迭代器。

`PrototypeDescriptor`为模型自行填充的描述子。该模型定义了模型的元数据，诸如Prototype名称、输入数据的维度、输出数据的维度、参数的解释说明、可用的Updater等。

`getMultiLayerConfiguration`允许模型返回自己的网络结构配置，这是支持任意网络结构的前提。目前只实现了MLP模型，但通过不同的实现方式，该方法允许使用CNN、GAN等复杂的网络模型，而不必大改其它部分的代码。

`getModelInputSizeFromDataInputSize`提供将模型输入（二维图像）的大小转换为模型实际需要的数据尺寸（例如1位数组，MLP；或二维数组，CNN）。

`getModelOutputSizeFromLabelSize`与上面的方法类似，对模型输出。

#### mlp.mnist

该包下是上述各接口的实现，实现为有一层隐藏层的多层感知机网络。输入维度是[28 * 28]，输出维度[10]。



